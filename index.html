<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kibriya MediTonic - Order Online</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,'Noto Sans',sans-serif;max-width:800px;margin:20px auto;padding:10px}
    label{display:block;margin-top:10px;font-weight:600}
    input,textarea,select{width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px}
    button{background:#0b67d0;color:#fff;padding:10px 16px;border:0;border-radius:6px;margin-top:12px;cursor:pointer}
    .note{font-size:14px;color:#555}
  </style>
</head>
<body>
  <h1>Kibriya MediTonic â€” Order Online</h1>
  <p class="note">Hotline: 01839849549 | Address: Parbatipur, Dinajpur</p>

  <form id="orderForm">
    <label>Customer Name<input type="text" id="name" required></label>
    <label>Mobile Number<input type="text" id="phone" required></label>
    <label>Address<textarea id="address" rows="2" required></textarea></label>
    <label>Delivery Type
      <select id="delivery_type">
        <option value="city">City (20 Tk)</option>
        <option value="outside">Outside City (120 Tk)</option>
      </select>
    </label>
    <label>Payment Method
      <select id="payment_method">
        <option value="COD">Cash on Delivery</option>
        <option value="bKash">bKash</option>
        <option value="Nagad">Nagad</option>
      </select>
    </label>
    <label>Medicine list (one per line, e.g. "Napa 500mg - 2 strip")<textarea id="items" rows="4" required></textarea></label>
    <label>Prescription (required for antibiotics)<input type="file" id="prescription"></label>
    <button type="submit">Place Order</button>
  </form>

  <div id="status" style="margin-top:12px"></div>

<script>
const SUPABASE_URL = "https://engpvhpzxkfkxldtziql.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuZ3B2aHB6eGtma3hsZHR6aXFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDA0MTQsImV4cCI6MjA4MDAxNjQxNH0.WTdUH8xGnz34cs6iivb-rM2A1GlyEQGN1qtIATVFQek";
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

async function uploadPrescription(file){
  if(!file) return null;
  const bucket = 'prescriptions';
  const filename = Date.now() + '_' + file.name.replace(/\s+/g,'_');
  const res = await supabase.storage.from(bucket).upload(filename, file, { upsert: false });
  if(res.error){ console.error('Upload error', res.error); throw res.error; }
  const publicUrl = SUPABASE_URL + '/storage/v1/object/public/' + encodeURIComponent(filename);
  return publicUrl;
}

document.getElementById('orderForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();
  const items = document.getElementById('items').value.trim();
  const delivery_type = document.getElementById('delivery_type').value;
  const payment_method = document.getElementById('payment_method').value;
  const presFile = document.getElementById('prescription').files[0];

  document.getElementById('status').innerText = 'Submitting order...';

  try{
    const presUrl = presFile ? await uploadPrescription(presFile) : null;
    const order = {
      customer_name: name,
      phone: phone,
      address: address,
      items: items,
      delivery_type: delivery_type,
      payment_method: payment_method,
      prescription_url: presUrl,
      delivery_charge: delivery_type === 'city' ? 20 : 120,
      status: 'pending'
    };
    const resp = await supabase.from('orders').insert([order]).select();
    if(resp.error){ throw resp.error; }
    const data = resp.data;
    document.getElementById('status').innerHTML = '<strong>Order placed!</strong> Order ID: ' + data[0].id;
    document.getElementById('orderForm').reset();
  }catch(err){
    console.error(err);
    document.getElementById('status').innerText = 'Error: ' + (err.message || JSON.stringify(err));
  }
});
</script>

</body>
</html>
